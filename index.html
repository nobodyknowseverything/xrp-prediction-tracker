<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XRP Live Global Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/three@0.152.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.152.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three-globe@2.25.0/dist/three-globe.min.js"></script>
<style>
  body { margin: 0; background: #000; color: #fff; font-family: system-ui; }
  #globeViz { width: 100%; height: 560px; position: relative; }
  @media (max-width: 768px) { #globeViz { height: 360px; } }
  .globe-fallback { display: flex; align-items: center; justify-content: center; height: 100%; background: rgba(0,0,0,0.5); color: #ef4444; font-size: 1.2rem; }
</style>
</head>
<body>
<div class="max-w-7xl mx-auto p-6 space-y-12">
  <h1 class="text-center text-5xl font-bold bg-gradient-to-r from-cyan-400 to-blue-600 bg-clip-text text-transparent">
    XRP Live Global Dashboard
  </h1>
  <div class="grid lg:grid-cols-3 gap-8 min-h-[600px]">
    <!-- Globe -->
    <div class="lg:col-span-2 bg-gray-950 rounded-3xl overflow-hidden border border-cyan-900/40 shadow-2xl flex flex-col">
      <div class="p-6 border-b border-gray-800 flex-shrink-0">
        <h2 class="text-2xl font-bold">Live Global Trade Flow</h2>
        <p class="text-cyan-300 text-sm">Green arcs = buys Red arcs = sells (appears in 3–5 seconds)</p>
      </div>
      <div id="globeViz">
        <div class="globe-fallback" id="fallbackMsg">Loading globe...</div>
      </div>
    </div>
    <!-- Right column -->
    <div class="space-y-6 flex flex-col">
      <div class="grid grid-cols-2 gap-6 flex-shrink-0">
        <div class="bg-gray-900/90 rounded-2xl p-6 border border-gray-800">
          <div class="text-gray-400 text-sm">XRP Price</div>
          <div id="price" class="text-4xl font-bold">$?.????</div>
          <div id="change" class="text-green-400 mt-1">—</div>
        </div>
        <div class="bg-gray-900/90 rounded-2xl p-6 border border-gray-800">
          <div class="text-gray-400 text-sm">24h Volume</div>
          <div id="volume" class="text-3xl font-bold">$?.??B</div>
        </div>
      </div>
      <div class="bg-gray-900/90 rounded-2xl p-6 border border-gray-800 flex-1">
        <h3 class="font-bold mb-3">Live Trades</h3>
        <div id="trades" class="text-sm space-y-1 max-h-64 overflow-y-auto"></div>
      </div>
      <div class="bg-gray-900/90 rounded-2xl p-6 text-center border border-gray-800 flex-shrink-0">
        <div class="text-gray-400 text-sm">Order-Book Depth (top 10)</div>
        <div class="text-3xl font-bold mt-3">
          <span class="text-green-400" id="bid">?.?k</span> │ <span class="text-red-400" id="ask">?.?k</span> XRP
        </div>
      </div>
    </div>
  </div>
  <!-- ETF Cards -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-6" id="etfContainer"></div>
  <!-- Clock -->
  <div class="text-center py-12 bg-gradient-to-r from-cyan-900/40 to-blue-900/40 rounded-3xl border border-cyan-700">
    <div id="status" class="text-6xl font-bold text-green-400">LOADING</div>
    <div id="clock" class="text-7xl font-mono my-6">--:--:-- ET</div>
  </div>
</div>
<script>
let globeInstance = null; // Global ref for arcs

// Globe setup with heavy error handling
async function initGlobe() {
  const globeVizEl = document.getElementById('globeViz');
  const fallbackEl = document.getElementById('fallbackMsg');
  try {
    // Wait for libs to load
    await new Promise(resolve => {
      if (window.ThreeGlobe && window.THREE) resolve();
      else setTimeout(resolve, 100);
    });

    const { Scene, PerspectiveCamera, WebGLRenderer, AmbientLight, DirectionalLight } = THREE;
    const { OrbitControls } = window;
    const ThreeGlobe = window.ThreeGlobe;

    const globe = new ThreeGlobe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .showAtmosphere(true)
      .atmosphereColor('#00ccff')
      .atmosphereAltitude(0.22);

    const scene = new Scene();
    scene.add(globe);
    scene.add(new AmbientLight(0xbbbbbb));
    scene.add(new DirectionalLight(0xffffff, 0.8));

    const camera = new PerspectiveCamera(75, globeVizEl.offsetWidth / globeVizEl.offsetHeight, 0.1, 1000);
    camera.position.z = 2.5;

    const renderer = new WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    
    function resizeRenderer() {
      const width = globeVizEl.offsetWidth;
      const height = globeVizEl.offsetHeight;
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
    }
    resizeRenderer();
    globeVizEl.appendChild(renderer.domElement);
    fallbackEl.style.display = 'none';

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.5;
    controls.enableZoom = true;
    controls.enablePan = false;

    function animate() {
      controls.update();
      globe.rotation.y -= 0.002; // Slow spin
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    window.addEventListener('resize', resizeRenderer);
    globeInstance = globe;
    console.log('Globe loaded successfully!');
  } catch (error) {
    console.error('Globe error:', error);
    fallbackEl.innerHTML = 'Globe unavailable (3D not supported?)—enjoy the dashboard anyway!';
    fallbackEl.style.color = '#fbbf24'; // Yellow for non-fatal
  }
}

// Arc shooter (works even without globe)
const cities = [
  { lat: 40.7, lng: -74 }, { lat: 51.5, lng: -0.1 }, { lat: 35.7, lng: 139.7 },
  { lat: 1.35, lng: 103.8 }, { lat: -33.9, lng: 151.2 }
];
function shootArc() {
  if (!globeInstance) return; // Skip if no globe
  const city = cities[Math.floor(Math.random() * cities.length)];
  const isBuy = Math.random() > 0.5;
  const arc = {
    startLat: city.lat, startLng: city.lng,
    endLat: (Math.random() - 0.5) * 60, endLng: (Math.random() - 0.5) * 120,
    color: isBuy ? 'lime' : 'red',
    stroke: 0.5 + Math.random() * 0.5
  };
  const currentArcs = globeInstance.arcsData() || [];
  globeInstance.arcsData([...currentArcs, arc]);
  setTimeout(() => {
    globeInstance.arcsData(currentArcs.filter(a => a !== arc));
  }, 5000 + Math.random() * 2000);
}

// Live trades + arc trigger
let currentPrice = 0.52; // 2025 starting point
function addTrade() {
  const isBuy = Math.random() > 0.5;
  const qty = (Math.random() * 100 + 10).toFixed(1);
  currentPrice += (Math.random() - 0.5) * 0.005;
  const tradeEl = document.createElement('div');
  tradeEl.className = isBuy ? 'text-green-400' : 'text-red-400';
  tradeEl.textContent = `${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}  ${qty} XRP  $${currentPrice.toFixed(4)}`;
  const tradesEl = document.getElementById('trades');
  tradesEl.insertBefore(tradeEl, tradesEl.firstChild);
  if (tradesEl.children.length > 10) tradesEl.removeChild(tradesEl.lastChild);
  shootArc();
}

// Real price update (with fallback)
async function updatePrice() {
  try {
    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true');
    if (!response.ok) throw new Error('API fail');
    const data = await response.json();
    currentPrice = data.ripple.usd;
    document.getElementById('price').textContent = `$${currentPrice.toFixed(4)}`;
    const change = data.ripple.usd_24h_change;
    const changeEl = document.getElementById('change');
    changeEl.textContent = (change > 0 ? '+' : '') + change.toFixed(2) + '%';
    changeEl.className = change > 0 ? 'text-green-400 mt-1' : 'text-red-400 mt-1';
    document.getElementById('volume').textContent = `$${(data.ripple.usd_24hr_vol / 1e9).toFixed(2)}B`;
  } catch (error) {
    console.warn('Price API error, using sim:', error);
    // Simulate tick
    currentPrice += (Math.random() - 0.5) * 0.01;
    document.getElementById('price').textContent = `$${currentPrice.toFixed(4)}`;
  }
}

// Order book sim
setInterval(() => {
  document.getElementById('bid').textContent = (Math.random() * 10 + 5).toFixed(1) + 'k';
  document.getElementById('ask').textContent = (Math.random() * 10 + 5).toFixed(1) + 'k';
}, 8000);

// ETFs (static demo)
const etfs = ['Canary XRPC $243M', 'Bitwise XRPT $135M', 'Franklin EZRP $63M', 'Grayscale GXRP $67M', '21Shares AXRP $5M'];
etfs.forEach(etf => {
  const div = document.createElement('div');
  div.className = 'bg-gray-900/90 rounded-2xl p-6 text-center border border-gray-800';
  const parts = etf.split(' ');
  div.innerHTML = `<div class="font-bold">${parts[0]} ${parts[1]}</div><div class="text-3xl font-bold text-cyan-300">${parts[2]}</div><div class="text-sm text-gray-400">purchased</div>`;
  document.getElementById('etfContainer').appendChild(div);
});

// Market clock
function updateClock() {
  const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const hours = now.getHours(), day = now.getDay();
  const isLive = day >= 1 && day <= 5 && hours >= 9 && hours < 16;
  document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }) + ' ET';
  const statusEl = document.getElementById('status');
  statusEl.textContent = isLive ? 'LIVE' : 'CLOSED';
  statusEl.className = isLive ? 'text-6xl font-bold text-green-400' : 'text-6xl font-bold text-red-400';
}
setInterval(updateClock, 1000);
updateClock();

// Kick it off
setTimeout(initGlobe, 500); // Delay for script load
updatePrice();
setTimeout(addTrade, 2000);
setInterval(addTrade, 3000);
setInterval(updatePrice, 10000); // Slower to avoid rate limits
console.log('Dashboard initializing...');
</script>
</body>
</html>
